SHORTNAME=rott
LONGNAME="Rise of the Triad"

ZIPSUM=0fafd6b629eab80278fc726e31f9cf41

rott_usage() {
	echo "${SHORTNAME} arguments:"  >&2
	printf "\tzipfile - path to 1rott13.zip\n" >&2
}

verify_args() {
	if [ $# -ne 1 ]; then
		echo "error: no zipfile specified" >&2
		usage >&2
		rott_usage >&2
		exit 1
	fi
}

checksum() {
	CHECKSUM=`md5sum "$1" | cut -d' ' -f1`
	debug "checksum = $CHECKSUM"
}

DEBBASE="rott-data_${GAME_PACKAGE_VERSION}_all.deb"

# XXX: should be in lib/game-data-package-shared
DATADIR="/usr/share/games/game-data-packager"

SHAREDIR="usr/share/games/rott"

if [ -f "$PWD/$DEBBASE" ]; then
	DEB="$PWD/$DEBBASE"
else
	DEB="$DATADIR/$DEBBASE"
fi


go() {
	verify_args "$@"
	ZIPFILE=`unravel "$1"`
    [ -f "$ZIPFILE" ] || die "ERROR: '$ZIPFILE' does not exist."
	checksum "$ZIPFILE"
	if [ "$CHECKSUM" != "$ZIPSUM" ]; then
		echo "warning: checksum is not what we expected" >&2
	fi

	# XXX: this para copied from lib/doom-common. Should be generalised.
	if [ "" = "$OUTDIR" ]; then
		OUTFILE="$WORKDIR/out.deb"
	else
		OUTFILE=`unravel "$OUTDIR"`"/$DEBBASE"
	fi
	cp -p "$DEB" "$OUTFILE"

	oldpwd=`pwd`
	cd "$WORKDIR"

	unzip -qqo "$ZIPFILE" ROTTSW13.SHR
	unzip -qqo "ROTTSW13.SHR"
	rm ROTTSW13.SHR

    # list of files from within the ZIP-inside-ZIP required for play
    files="HUNTBGIN.RTC HUNTBGIN.RTL HUNTBGIN.WAD REMOTE1.RTS"

    # XXX: we have to re-implement most of slipstream() here, due
    # to the way we use it
    slipstream_permcheck "$OUTFILE"
    slipstream_unpack "$OUTFILE"
    for file in $files; do
        # XXX: files are treated as being relative to $WORKDIR, hence
        # unpacking straight into it. Might be nicer to tidy away the
        # unpack into a subdir (no risk of stamping over another part
        # of g-d-p's operation) and specify full paths
        slipstream_file "$file" "$SHAREDIR/$file"
    done
    slipstream_file "VENDOR.DOC" "usr/share/doc/rott-data/VENDOR.DOC"
    slipstream_instsize
    slipstream_repack "$OUTFILE"
    slipstream_cleanup

	rm $files

	cd "$oldpwd"
}
